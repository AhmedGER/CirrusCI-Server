name: server
on:
  workflow_dispatch:

jobs:
  minecraft:
    runs-on: ubuntu-latest
    timeout-minutes: 360
    steps:
      - uses: actions/checkout@v4

      - name: Set up Java 21
        uses: actions/setup-java@v3
        with:
          distribution: 'temurin'
          java-version: '21'

      - name: Setup World if found
        run: |
          if [ -f world.zip ]; then
            echo "=== Extracting world.zip ==="
            unzip -q world.zip
            echo "✔ World extracted successfully"
          else
            echo "ℹ️ No world.zip found, using existing world"
          fi
          
      - name: Setup Playit Tunnel with Auto-Restart
        run: |
          echo "=== Setting up Playit Tunnel with monitoring ==="
          
          chmod +x playit-linux-amd64
          
          if [ -n "${{ secrets.PLAYIT_SECRET }}" ]; then
            echo "${{ secrets.PLAYIT_SECRET }}" > playit.toml
            echo "✔ Playit configured from secrets"
          elif [ -f playit.toml ]; then
            echo "✔ Using existing playit.toml"
          else
            echo "⚠️ No playit config found"
          fi
          
          while true; do
            ./playit-linux-amd64 >/dev/null 2>&1 || sleep 5
          done &
          
          echo "✔ Playit tunnel started with auto-restart"
          echo "ℹ️ Minecraft port (25565) and RCON port (25575) will be tunneled"
          sleep 10
          
      - name: Run Minecraft Server
        run: |
          echo "=== Starting Minecraft Server ==="
          
          java -DPaper.IgnoreJavaVersion=true \
            -Xmx21G -Xms18G \
            -XX:+UseG1GC \
            -XX:+ParallelRefProcEnabled \
            -XX:MaxGCPauseMillis=200 \
            -XX:+UnlockExperimentalVMOptions \
            -XX:+DisableExplicitGC \
            -XX:+AlwaysPreTouch \
            -XX:G1NewSizePercent=30 \
            -XX:G1MaxNewSizePercent=40 \
            -XX:G1HeapRegionSize=16M \
            -XX:G1ReservePercent=20 \
            -XX:G1HeapWastePercent=5 \
            -XX:G1MixedGCCountTarget=4 \
            -XX:InitiatingHeapOccupancyPercent=15 \
            -XX:G1MixedGCLiveThresholdPercent=90 \
            -XX:G1RSetUpdatingPauseTimePercent=5 \
            -XX:SurvivorRatio=32 \
            -XX:+PerfDisableSharedMem \
            -XX:MaxTenuringThreshold=1 \
            -Dusing.aikars.flags=https://mcflags.emc.gs \
            -Daikars.new.flags=true \
            -jar fabric-server.jar --nogui &
          SERVER_PID=$!
          
          echo "✔ Minecraft Server started (PID: $SERVER_PID)"
          echo "⏰ Server will run for max 5 hours 45 minutes..."
          
          echo "⏳ Waiting 1 minute for server to fully start..."
          sleep 60
          
          echo ""
          echo "=== Server is now ONLINE ==="
          echo "ℹ️ Type 'stop' in-game to shutdown server immediately"
          
          MAX_TIME=20700
          ELAPSED=0
          CHECK_INTERVAL=10
          
          while [ $ELAPSED -lt $MAX_TIME ]; do
            if ! kill -0 $SERVER_PID 2>/dev/null; then
              echo ""
              echo "=== Server Stopped by User ==="
              echo "⏱️ Server ran for approximately $((ELAPSED / 60)) minutes"
              break
            fi
            
            sleep $CHECK_INTERVAL
            ELAPSED=$((ELAPSED + CHECK_INTERVAL))
            
            if [ $((ELAPSED % 1800)) -eq 0 ]; then
              echo "⏰ Server running... $((ELAPSED / 60)) minutes elapsed"
            fi
          done
          
          if kill -0 $SERVER_PID 2>/dev/null; then
            echo ""
            echo "=== Time Limit Reached - Stopping Server ==="
            kill -TERM $SERVER_PID 2>/dev/null || true
            sleep 5
            kill -9 $SERVER_PID 2>/dev/null || true
          fi
          
          pkill -f "monitor_playit.sh" 2>/dev/null || true
          pkill -TERM playit-linux-amd64 2>/dev/null || true
          sleep 2
          pkill -9 playit-linux-amd64 2>/dev/null || true
          
          echo "✔ Server stopped"
          
          if [ -f playit_monitor.log ]; then
            echo "=== PlayIt Monitor Log ==="
            tail -n 10 playit_monitor.log
          fi
          
      - name: Save world and config
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          git add -A
          
          if ! git diff --cached --quiet 2>/dev/null; then
            git commit -m "Auto-save: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
            git pull --rebase --autostash \
              https://x-access-token:${{ secrets.PAT }}@github.com/${{ github.repository }}.git
            git push https://x-access-token:${{ secrets.PAT }}@github.com/${{ github.repository }}.git
            echo "✔ Changes saved to repository"
          else
            echo "ℹ️ No changes to save"
          fi
          
      - name: Auto-retrigger workflow
        if: github.run_attempt < 3
        env:
          GH_TOKEN: ${{ secrets.PAT }}
        run: |
          runs=$(gh run list -w server.yml --json status -q \
               '[.[] | select(.status=="queued" or .status=="in_progress")] | length')
          
          if [ "$runs" -le 1 ]; then
            echo "No other workflows running, retriggering..."
            gh workflow run server.yml
            echo "✔ Workflow retriggered"
          else
            echo "Other workflows are running, skipping retrigger"
          fi
